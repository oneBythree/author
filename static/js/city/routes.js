"use strict";function postLineList(e,t,i,o,n,r){t=t?t:0;var a=$.param({time:t,route:i,page:o,size:n}),s="/api/city/"+encodeURIComponent(e)+"/routes?"+a;getJson(s,function(e){var t=e.data.data,i=e.data;$.each(t,function(e,i){t[e].startTime=Context.getTime(i.startTime),t[e].userinfo.carModel=Context.getCarBrand(i.userinfo.carModel)}),r(t,i)})}function wxConfig(e,t){if(e){var i={title:t.title,desc:t.desc,link:t.url,imgUrl:t.imgurl};e.onMenuShareAppMessage(i),e.onMenuShareTimeline(i),e.onMenuShareQQ(i),e.onMenuShareQZone(i)}}function handleRoutes(e,t,i){0==i&&(e.listData=[]);for(var o=0;o<t.length;o++){var n=t[o],r=e.timeMarkMap.latest_time;n.today=new Date(1e3*n.created_at).toString().substr(0,15),(!r[n.today]||r[n.today]<n.created_at)&&(r[n.today]=n.created_at),e.listData.push(n)}for(var a=0;a<t.length;a++)e.timeMarkMap.addItem(t[a])}function fetchData(e,t,i,o,n,r,a){if("undefined"==typeof r&&(r=15),i=i?i:0,location.href.indexOf("#day=")>=0){var s=location.href.match(/day=(\d+)/);o=s[1],e.info.time=Number.parseInt(o),location.href=location.href.replace(/day=\d+/,"")}postLineList(t,o,i,n,r,function(t,i){var o=i.routes;if(n>1)handleRoutes(e,t,!0);else{if(""==e.des&&o&&o.length){var s=o[0];e.$set("des",s.des),e.info.route=s.id,s.src&&e.$set("origin",s.src)}o.length>0&&e.$set("routes",o),handleRoutes(e,t,!1)}if(e.$set("page",i.page),e.$set("pagetotal",i.pagetotal),1==Number.parseInt(n)&&"undefined"!=typeof jWeixin&&i.wx&&i.wx.msg){var u=i.wx.msg;u.link=u.url=location.href.split("#")[0],wxConfig(jWeixin,u)}a&&(a.endPullupToRefresh(n>=e.pagetotal),t.length<r&&1==n?a.disablePullupToRefresh():1==n&&t.length==r&&a.enablePullupToRefresh()),e.is_ready=!0})}function dateJson(e){var t=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],i=["周日","周一","周二","周三","周四","周五","周六"],o=/\d+/g,n=new Date;if(void 0!=e){var r=e.match(o);n=new Date(r[0],parseInt(r[1])-1,r[2])}var a=n.getFullYear(),s=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,u=n.getDate()<10?"0"+n.getDate():n.getDate(),c=(t[n.getDay()],i[n.getDay()]),f=a+"-"+s+"-"+u,d=s+"-"+u+" "+c,m=Context.getUnix(f);return{numDate:f,ZhDate:d,unixTime:m}}var today=new Date,params=localParam();Vue.config.delimiters=["@{","}"],Vue.filter("pubMark",function(e){if(!e)return"";var t=new Date(1e3*e),i=t.getMonth()+1,o=t.getDate(),n=i+"月"+o+"日 "+t.toString().substr(16,5);return today.getDate()==t.getDate()&&(n=n.substr(6)),n});var vmSearch=new Vue({el:"body",data:function(){var e={headerMark:[],latest_time:{},addItem:function(e){var t=Number.parseInt(e.created_at/300);(0==e.routeinfo.is_driver||e.userinfo.verified&&1==e.routeinfo.is_driver)&&(t=Number.parseInt(this.latest_time[e.today]/300)),void 0===this[t]&&(this[t]=[]),this[t].push(e.id)},buildTime:function(e){var t=Number.parseInt(e.created_at/300),i=t;(0==e.routeinfo.is_driver||e.userinfo.verified&&1==e.routeinfo.is_driver)&&(t=Number.parseInt(this.latest_time[e.today]/300));var o=e.created_at;return o=void 0==this[t]?e.created_at:0==this[t].indexOf(e.id)?i==t?e.created_at:this.latest_time[e.today]:0}};return{info:{time:0,route:0,limit:15},userInfo:{},isCp:!1,origin:"",des:"",routes:[],listData:[],page:0,params:localParam(),timeMarkMap:e,is_ready:!1,pagetotal:0,city:"",dateJson:{},sms:{status:0,time:60},status:{showLoginForm:0}}},created:function(){function e(){self.pullUpUtil=this,self.pullUpRefresh(self.pullUpUtil)}this.checkCooperation(),this.getHash(),this.$set("dateJson",dateJson()),this.getUserInfo(),self=this,mui.init({pullRefresh:{container:"#htRoutes",up:{height:50,auto:!0,contentnomore:"没有更多数据了",contentrefresh:"正在加载...",callback:e}}})},methods:{getHash:function(){var e=this.params;if("undefined"==typeof e)return void(window.location.href="/city/location?ref=location");if(e.city){var t=decodeURIComponent(e.city||"");this.$set("city",t)}this.info.route=e.route,this.info.time=e.day,this.info.time||(this.info.time=new Date((new Date).toDateString()).getTime()/1e3),this.info.time=Number.parseInt(this.info.time)},pullUpRefresh:function(e){fetchData(this,this.city,this.info.route,this.info.time,this.page+1,this.info.limit,e)},getUserInfo:function(){var e=this;postJson("/api/currentUser",function(t){if(1==t.codee){if(e.userInfo=t.data,"undefined"==typeof _hmt)return;var i="{v}:{wx}";i=e.userInfo.verifed?i.replace("{v}","认证车主"):i.replace("{v}","未认证"),i=e.userInfo.is_wx_fans?i.replace("{wx}","关注了海獭GO"):i.replace("{wx}","未关注"),params.utm_source&&(i=i+":访问过"+params.utm_source),_hmt.push(["_setCustomconst",1,"userType",i,1]),window.location.href&&window.location.href.indexOf("#from_route_pub")>-1&&e.routePub()}},function(){},function(){},!0)},callPhoneFuc:function(e){if(!e)return!1;window.location.href="tel:"+e;var t=this;if("undefined"!=typeof _hmt){var i=this.params.utm_source||"";_hmt.push(["_trackEvent",t.city,"p:"+e,i])}},collectFuc:function(e,t,i){},checkCooperation:function(){var e=this,t=window.location.href.toLowerCase();e.isCp=t.indexOf("utm_source")>0},routePicker:function(e){if(this.routes&&0!=this.routes){var t=new mui.PopPicker,i=this,o=[],n="<span class='iconfont icon-wangfan'></span>",r={};for(var a in i.routes)if(i.routes.hasOwnProperty(a)){var s=i.routes[a];if(1!=r[s.id]){var u=s.src||i.city;o.push({text:u+n+s.des+"（往返）",id:s.id,des:s.des,src:u}),r[s.id]=1}}t.setData(o),t.show(function(e){var t=e[0];i.des=t.des,i.origin=t.src,i.info.route=t.id,fetchData(i,i.city,t.id,i.info.time,1,10,i.pullUpUtil);var o={city:i.city,route:t.id};localStorage.setItem("page:loc:user:latest",JSON.stringify(o))})}},todayStr:function(){var e=new Date;return""+(e.getMonth()+1)+"."+e.getDate()},gotoPay:function(e){window.location.href="/user/pay?userid="+e.id},lineIsDriver:function(e){try{var t=e.routeinfo.is_driver;return"0"===t||0===t?0:1}catch(e){return 1}},routePub:function(){var e=this,t=this.origin||this.city,i=this.info.route,o="/city/publish?city=@{1}&id=@{2}#@{cp_conf}".replace("@{1}",encodeURIComponent(t)).replace("@{2}",i),n="";if(e.isCp&&e.params&&e.params.utm_source&&(n="&utm_source="+encodeURIComponent(this.params.utm_source)),o=o.replace("#@{cp_conf}",n),e.userInfo&&e.userInfo.id&&e.userInfo.mobilePhoneNumber&&e.userInfo.nickName)window.location.href=o;else if(e.userInfo&&e.userInfo.id&&e.userInfo.nickName)e.status.showLoginForm=1;else{window.haitago&&window.haitago.appID||mui.toast("配置错误， 请联系管理员");var r="https://open.weixin.qq.com/connect/oauth2/authorize?appid=@{app_id}&response_type=code&scope=snsapi_userinfo&state=123&redirect_uri=";r=r.replace("@{app_id}",window.haitago.appID);var a="?next="+encodeURIComponent(window.location.href+"##from_route_pub");window.location.href=r+"http%3A%2F%2F"+window.location.host+"%2Fweixin%2Fredirectback"+encodeURIComponent(a)}},checkRouteStatus:function(e){1==e||"1"==e?mui.toast("车满了"):mui.toast("有车了")},mobileLogin:function(){var e=this,t=document.querySelector("input[name=mobile]"),i=document.querySelector("input[name=code]");if(t&&i)try{t=t.value.toString().trim(),i=i.value.toString().trim()}catch(e){t=i=""}if(!t||!i)return mui.toast("请填写正确的信息"),!1;var o={mobile:t,code:i},n="/api/user/captcha/check";$.post(n,o,function(t){return"1"==t.codee?void(location.href.indexOf("#from_list_routes")>-1?location.href="/myroute":location.href.indexOf("#from_route_pub")>-1&&(location.href="/city/publish?"+$.param({city:e.city,route:e.info.route}))):void mui.toast("手机号或者验证码错误")})},sendSMS:function(){var e=document.querySelector("input[name=mobile]"),t=e.value;if(t=t.toString().trim(),!t)return void mui.toast("请输入手机号");if(!/1\d{10}/.test(t))return void mui.toast("请输入正确的手机号");var i="/api/getLoginSmsCode",o={mobile:t},n=this;$.post(i,o,function(e,t){"1"==e.codee?!function(){mui.toast("发送成功，请等待短信验证码"),n.sms.time=60,n.sms.status=1;var e=function e(){return n.sms.time<=0?void(n.sms.status=0):(n.sms.time-=1,void setTimeout(e,1e3))};setTimeout(e,1e3)}():e.message?mui.toast(e.message):mui.toast("未知错误，请联系管理员")})},showLineExtra:function(e){var t=e.userinfo;return!!t&&!!(t.carModel.toString().trim()||t.weixin_payurl.toString().trim()||t.zhifubao_payurl.toString().trim())},closeLoginForm:function(){this.status.showLoginForm=0},listRoutes:function(){var e=this,t="/myroute";if(e.userInfo&&e.userInfo.id&&e.userInfo.mobilePhoneNumber&&e.userInfo.nickName)window.location.href=t;else if(e.userInfo&&e.userInfo.id&&e.userInfo.nickName)e.status.showLoginForm=1;else{window.haitago&&window.haitago.appID||mui.toast("配置错误，请联系管理员");var i="https://open.weixin.qq.com/connect/oauth2/authorize?appid=@{app_id}&response_type=code&scope=snsapi_userinfo&state=123&redirect_uri=";i=i.replace("@{app_id}",window.haitago.appID);var o="?next="+encodeURIComponent(window.location.href+"##from_list_routes");window.location.href=i+"http%3A%2F%2F"+window.location.host+"%2Fweixin%2Fredirectback"+encodeURIComponent(o)}},tapCP:function(){if("undefined"!=typeof _hmt){var e="/tap/routes/cp:{{form}}".replace("{{from}}",params.utm_source);_hmt.push(["_trackPageview",e])}}}});