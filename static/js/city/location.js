"use strict";function getCache(t){var e=localStorage.getItem(t);e=e?e:"[]",e=JSON.parse(e);var i=[],r={};for(var a in e)if(e.hasOwnProperty(a)){var n=e[a];r[n.name]||(r[n.name]=1,i.push(n))}return i}function setCache(t,e){localStorage.setItem(t,JSON.stringify(e))}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$=window.$;Vue.config.delimiters=["@{","}"];var vmLocation=new Vue({el:"body",data:{blurEvt:null,selected:{},cityList:[],map:{lines:[]},search:$.map(window.location.search.split("&"),function(t,e){})},created:function(){this.init(),this.historyList=this.getHistory(),this.fetchCities(),this.getMap()},computed:{querySet:function(){if(!this.query)return[];var t=this.cityList,e={},i=this;for(var r in Object.keys(t))$.extend(e,t[r]);var a="",n=[];return $.each(Object.keys(e),function(t,r){var o=e[r].items;for(var c in o)if(o.hasOwnProperty(c)){var s=o[c];s.name.indexOf(i.query)==-1&&s.remark.indexOf(i.query.toLowerCase())==-1||a.indexOf(s.remark)==-1&&(n.push(s),a=a+"("+s.remark+")")}}),n},localParam:function(){var t=window.location.search,e=function(t,e){if(t){var i=function(){var i={};return t.replace(e,function(t,e,r,a){i[e]=a}),{v:i}}();if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}};return e(t,new RegExp("([^?=&]+)(=([^&]*))?","g"))}},methods:{init:function(){var t=this.localParam;if(t&&"undefined"!=typeof t.smart&&"undefined"!=typeof t.ref){var e="page:loc:user:latest",i=JSON.parse(localStorage.getItem(e));if(null!==i){$("body").hide();var r="publish"===t.ref?"publish":"routes";i&&i.city&&(i.city.indexOf("%")!=-1&&(i.city=decodeURIComponent(i.city)),window.location.replace("/city/{sub}?".replace("{sub}",r)+$.param(i)))}}},clkChar:function(t){var e=t.target;$("#city-pool").insertAfter($(e).parent(".city-row"));var i=e.dataset.group,r=e.dataset.char,a=this.cityList[i][r];this.selected={char:r,group:i,list:a.items},$(".city-row .char").siblings().removeClass("active"),$(e).addClass("active")},clkCity:function(t){this.blurEvt&&(clearTimeout(this.blurEvt),this.blurEvt=null);var e="city:history:names",i=getCache(e);i=i?i:[];var r=t.target,a=r.innerText.trim(),n=Math.round(r.dataset.id||0);if(a!=this.map.location||0!=this.map.lines.length){var o={city:a,route:n},c=$.param(o);$.each(i,function(t,e){return e.name!=a||(i.splice(t),!1)}),i.unshift({name:a,route:n}),i=i.length>6?i.slice(0,6):i,setCache(e,i),setCache("page:loc:user:latest",o),window.location.href.indexOf("ref=publish")>0?window.location.href="/city/publish?"+c:window.location.href="/city/routes?"+c}},clkPlaceHolder:function(t){t.target;document.querySelector("div.ht-search").className+=" ht-active",document.getElementById("ht-ipt-search").focus()},clkClear:function(){this.query="",document.getElementById("ht-ipt-search").focus()},getHistory:function(){for(var t=getCache("city:history:names")||[],e=[],i=0;i<t.length;i++)t[i].toString().trim()&&e.push(t[i].toString().trim());return t},fetchCities:function(){self=this;var t="/api/lines/group/char";$.get(t,function(t){self.$set("cityList",t.data.cities),self.$set("hotList",t.data.hotList)})},getMap:function(){var t=this;$.get("/api/user/location",function(e){e.data&&t.$set("map",e.data)})}}});