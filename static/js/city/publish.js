"use strict";function gen_time_items(){for(var e=[],t=[],o=0;o<12;o++){var r=(100+5*o).toString().substr(1,2);e.push({text:r+"分",value:r})}for(var a=0;a<13;a++){var i=(100+a).toString().substr(1,2);t.push({text:i+"点",children:e,value:a})}return t}var params=localParam(window.location.search),PageTool={loadForm:function(e){if(sessionStorage.publishForm){var t=JSON.parse(sessionStorage.publishForm);document.querySelector("#mobile").value=t.mobile,document.querySelector("#message").value=t.message,e.info.is_driver=t.is_driver,sessionStorage.publishForm=""}if(sessionStorage.carInfo)try{var o=JSON.parse(sessionStorage.carInfo);o&&o.model&&o.name&&(e.info.carInfo=o)}catch(e){}},saveForm:function(e){var t={message:document.querySelector("#message").value,mobile:document.querySelector("#mobile").value,is_driver:e.info.is_driver};sessionStorage.publishForm=JSON.stringify(t)}};Vue.config.delimiters=["@{","}"];var app=new Vue({el:"body",data:function(){for(var e=JSON.parse(jQuery("#cityRoutes").val()),t="<span class='iconfont icon-wangfan'></span>",o=0;o<e.length;o++)e[o].text=decodeURIComponent(params.city)+t+e[o].des+"（往返）";var r=!0,a=location.search.indexOf("utm_source")>-1;return{des:e[0].des,userInfo:{},routes:e,info:{route_id:e[0].id,is_driver:1,carInfo:{name:"",model:0},payment:[],delPayment:0},context:{showMask:r,page_ready:!1},isCp:a,holder:{1:"可说明 去哪儿，出发时间，可捎几人，价格等",0:"可说明 去哪儿，几人乘车，是否有大件行李等"}}},computed:{hasCarInfo:function(){var e=this.info.carInfo;return e&&e.model&&e.name.toString().trim()},carName:function(){return this.info.carInfo.name.toString().trim()},hasPayment:function(){var e=this.info;return e&&e.payment&&e.payment.length>0}},created:function(){this.getHash(),this.$set("city",decodeURIComponent(params.city)),this.getUserInfo()},methods:{getHash:function getHash(){var id=params.lineId,self=this,history=localStorage.getItem("arryHistory");if(null!==history&&void 0!=history&&""!=history){var changHistory=eval(history);id=JSON.parse(changHistory[0]).id}PageTool.loadForm(this)},getUserInfo:function(){var e=this,t="/api/currentUser";"undefined"!=typeof params.utm_source&&(t+="?utm_source="+params.utm_source),postJson(t,function(t){e.context.page_ready=!0;var o=t.data;if(e.userInfo=o,e.$set("nickName",o.nickName),e.$set("verified",o.verified),e.$set("driverRouteCount",o.driverRouteCount),e.$set("isWXFans",o.isWXFans),e.$set("isCp",o.isCp),e.isWXFans&&(e.context.showMask=!1),o.carModel&&e.info.carInfo&&!e.info.carInfo.model){var r=e.info.carInfo;r.model=Math.round(o.carModel),r.name=Context.getCarBrand(r.model)}o&&o.weixin_payurl&&e.info.payment.push(o.weixin_payurl)})},changLine:function(e){var t=$(e.target),o=t.attr("data-type"),r="",a="";1==o?(t.attr("data-type",2),r=this.stop,a=this.start):(t.attr("data-type",1),r=this.start,a=this.stop),$("#start").text(r),$("#stop").text(a)},relocation:function(){window.location.href="/city/location?ref=publish"},routePicker:function(e){for(var t=new mui.PopPicker,o=this,r=[],a={},i="<span class='iconfont icon-wangfan'></span>",n=0;n<o.routes.length;n++){var s=o.routes[n];if(1!=a[s.id]){var c=s.src||o.city;r.push({text:c+i+s.des+"（往返）",id:s.id,des:s.des,src:c}),a[s.id]=1}}t.setData(r),t.show(function(e){var t=e[0];o.des=t.des,o.origin=t.src;var r={city:o.city,route:t.id};o.info.route_id=t.id,localStorage.setItem("page:loc:user:latest",JSON.stringify(r))})},changeType:function(e){this.info.is_driver=1===e?1:0},maskTrigger:function(e){return"undefined"==typeof params.utm_source?void(window.location.href="/user/be-driver"):e===!0?void(this.context.showMask=!0):e===!1?void(this.context.showMask=!1):void(this.context.showMask=!this.context.showMask)},fillPayment:function(){PageTool.saveForm(this),location.href="/user/payment/edit"},nameIsNull:function(){var e=this.userInfo,t=e&&e.nickName&&e.nickName.toString().trim();return!t},getCarModel:function(){PageTool.saveForm(this),location.href="/car-brand"},clearPayment:function(){this.info.delPayment=1,this.info.payment=[]},clearModel:function(){this.info.carInfo={}}}});$(".btn-submit").on("click",function(e){var t=(new Date,document.getElementById("resultUl"),document.getElementById("nickname"));if(t=t&&t?t.value:"",""==t)return $.ModuleTip({txt:"昵称不能为空"}),!1;var o=document.getElementById("mobile");o=o&&o.value?o.value:"";var r=/^0?1[3|4|5|7|8][0-9]\d{8}$/;if(""==o)return $.ModuleTip({txt:"手机号不能为空"}),!1;if(!r.test(o))return $.ModuleTip({txt:"请填写11位手机号"}),!1;var a=document.getElementById("model");a=a&&a.dataset&&a.dataset.model?a.dataset.model:"";var i="",n=document.getElementById("message").value;if(""==n)return $.ModuleTip({txt:"行程详情不能为空"}),!1;if(n.length<6)return $.ModuleTip({txt:"行程详情长度不能小于6个字符"}),!1;var s=Math.round(document.querySelector("span[data-route]").dataset.route),c={is_driver:document.querySelector("div[data-driver]").dataset.driver,del_payment:app.info.delPayment,nickname:t,lineId:s,payment:i,phone:o,model:a,note:n},u=window.location.search.toLowerCase().indexOf("utm_source")>-1,d=u?"?utm_source="+params.utm_source:"",m="/api/lines/route/add"+d;if(postForm(m,c,function(e){window.location.href="/city/routes?city="+params.city+"&route="+c.lineId+d.replace("?","&")}),"undefined"!=typeof _hmt&&params.utm_source){var l="/trace/{{from}}/publish".replace("{{from}}",params.utm_source);_hmt.push(["_trackPageview",l])}var f=params.city&&params.city.indexOf("%")==-1?params.city:decodeURIComponent(params.city),p={city:f,route:s};localStorage.setItem("page:loc:user:latest",JSON.stringify(p))});